services:
  mongo:
    image: mongo:6
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]

  redis:
    image: redis:7
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    environment:
      - MONGO_URI=${MONGO_URI}
      - MONGO_DB=${MONGO_DB}
      - SUBJECTS_COLLECTION=${SUBJECTS_COLLECTION}
      - REDIS_URL=redis://redis:6379
      - PORT=${PORT}
      - ENRICHMENT_WINDOW_HOURS=${ENRICHMENT_WINDOW_HOURS}
      - IDEMPOTENCY_WINDOW_SECONDS=${IDEMPOTENCY_WINDOW_SECONDS}
      - PDL_API_KEY=${PDL_API_KEY}
      - WHITEPAGES_API_KEY=${WHITEPAGES_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PIPL_API_KEY=${PIPL_API_KEY}
      - PROVIDER_PIPL_ENABLED=${PROVIDER_PIPL_ENABLED}
      - AUTO_ENRICH_ENABLED=${AUTO_ENRICH_ENABLED}
      - AUTO_ENRICH_SWEEP_CRON=${AUTO_ENRICH_SWEEP_CRON}
      - RAW_PAYLOAD_TTL_HOURS=${RAW_PAYLOAD_TTL_HOURS}
      - QUEUE_CONCURRENCY=${QUEUE_CONCURRENCY}
      - BOND_THRESHOLD=${BOND_THRESHOLD}
      - HCSO_SCRAPE_ENABLED=${HCSO_SCRAPE_ENABLED}
      - HCSO_BASE_URL=${HCSO_BASE_URL}
      - HCSO_SCRAPE_MODE=${HCSO_SCRAPE_MODE}
    ports:
      - '4000:4000'
    depends_on:
      - mongo
      - mongo-setup
      - redis

  worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    environment:
      - MONGO_URI=${MONGO_URI}
      - MONGO_DB=${MONGO_DB}
      - SUBJECTS_COLLECTION=${SUBJECTS_COLLECTION}
      - REDIS_URL=redis://redis:6379
      - ENRICHMENT_WINDOW_HOURS=${ENRICHMENT_WINDOW_HOURS}
      - IDEMPOTENCY_WINDOW_SECONDS=${IDEMPOTENCY_WINDOW_SECONDS}
      - PDL_API_KEY=${PDL_API_KEY}
      - WHITEPAGES_API_KEY=${WHITEPAGES_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PIPL_API_KEY=${PIPL_API_KEY}
      - PROVIDER_PIPL_ENABLED=${PROVIDER_PIPL_ENABLED}
      - RAW_PAYLOAD_TTL_HOURS=${RAW_PAYLOAD_TTL_HOURS}
      - QUEUE_CONCURRENCY=${QUEUE_CONCURRENCY}
      - BOND_THRESHOLD=${BOND_THRESHOLD}
      - HCSO_SCRAPE_ENABLED=${HCSO_SCRAPE_ENABLED}
      - HCSO_BASE_URL=${HCSO_BASE_URL}
      - HCSO_SCRAPE_MODE=${HCSO_SCRAPE_MODE}
    depends_on:
      - mongo
      - mongo-setup
      - redis

  mongo-setup:
    image: mongo:6
    depends_on:
      - mongo
    entrypoint: ["bash", "-lc", "until mongosh --host mongo:27017 --eval 'db.runCommand({ ping: 1 })' >/dev/null 2>&1; do sleep 1; done; mongosh --host mongo:27017 --eval 'rs.initiate({_id:\"rs0\",members:[{_id:0,host:\"mongo:27017\"}]})' || true"]

volumes:
  mongo-data: {}
